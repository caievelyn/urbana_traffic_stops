---
title: "Urbana Traffic Stops"
author: "Evelyn Cai"
date: "6/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries
library(tidyverse)
library(janitor)
library(skimr)
library(lubridate)
library(tidymodels)
library(readxl)
library(patchwork)

# Read in data
df <- read_csv("urbana_traffic_stops.csv") %>%
  clean_names() %>%
  mutate(date_of_contact = mdy(date_of_contact))

# Additional ages
ages <- read_xlsx("Additional IDOT info.xlsx") %>%
  clean_names() %>%
  rename("incident_number" = "incident") %>%
  select(incident_number, age_at_contact) %>%
  unique()

# Join for ages
tstopoffenses <- left_join(df, ages, by = "incident_number") %>%
  rename("age_at_contact" = "age_at_contact.y") %>%
  select(-age_at_contact.x) %>%
  unique()
```

## Exploratory Data Analysis

```{r explore, eval=FALSE}
skim(tstopoffenses)
```

After runnning skim(), I wanted to explore why some values were missing. Some were obvious: `drug_amount_found_canine_search` was probably NA if a canine search was not involved. Others seem to be less logically missing, such as `motivation_for_stop_desc`, which has a lower complete rate compared to other variables. After exploring the data, I noticed that motivations were generally not reported before 4/30/2015.

```{r missing, eval=FALSE, include=FALSE}
# Filter for rows missing motivations and arrange by decreasing date; the largest date value is 4/30/2015. Note before we call the unique() function that there are 14,657 observations.
tstopoffenses %>%
  filter(is.na(motivation_for_stop_desc)) %>%
  select(date_of_contact) %>%
  unique() %>%
  arrange(desc(date_of_contact))

# Double check by approaching the problem in reverse: filter only for dates before 4/30/2015 (again, there are 14,657 observations). When filtering for those that have a motivation, there are only 11 - mostly traffic issues, one is community caretaking.
tstopoffenses %>% 
  filter(date_of_contact < "2015-04-30") %>%
  select(motivation_for_stop_desc) %>%
  filter(!is.na(motivation_for_stop_desc))
```

To work with the total number of traffic stops, rather than traffic stop offenses, we have to do some reshaping of the data.

```{r reshaping, echo=FALSE}

tstops <- tstopoffenses %>%
  group_by(incident_number) %>%
  # Create new variables that collapse multiple offenses into one column
  mutate(crime_descs  = paste(crime_description, collapse =", "),
         crime_codes = paste(crime_code, collapse = ", "),
         crime_status_descs = paste(crime_status_description, collapse = ", "),
         crime_categories = paste(crime_category, collapse = ", "),
         crime_category_descs = paste(crime_category_description, collapse = ", "),
         # Create new variable to count the number of offenses
         number_of_crimes = length(crime_codes)) %>%
  # Deselect duplicate columns
  select(-crime_code, -crime_description, -crime_status_description, -crime_category, -crime_category_description) %>%
  # Filter for unique incidents
  unique() %>%
  ungroup()

# skim(tstops)
  
```

Upon fiddling with the data more, here's what I hope to put together by the end of the project:
* Interaction plots and parallel slopes models for variables such as: disparity ratio, stops & resultant arrest %s, and % contraband found out of consent searches
* Easily digestible plots that show:
    + Breakdown of interacting variables
    + Outcome likelihoods after being stopped compared to a baseline (either group average or being white/male)
    + Impact of location (?) and time of day on the stop
    
## Initial Analysis

```{r cleaning, echo=FALSE, fig.width = 10}

# It seems like in 2018 "Caucasian" turned into "White" and "African American" to "Black". 

tstops_demo <- tstops %>%
  # Select only for useful demographic and logistical information
  select(date_of_contact, time_of_contact, incident_number,
        motivation_for_stop_desc, race_description, sex_description,
        age_at_contact, residency_code, reason_for_stop,
        type_of_violation, vehicle_year, crime_descs,
        crime_status_descs) %>%
  # Extract year and month from date
  mutate(year = year(date_of_contact),
         month = month(date_of_contact),
         # Change "Caucasian" to "White" and factorize race
         race_description = as.factor(case_when(
           race_description == "CAUCASIAN" ~ "WHITE",
           race_description == "AFRICAN AMERICAN" ~ "BLACK",
           TRUE ~ race_description))) %>%
  unique()

# There is one less observation in tstops_demo than tstops, but the same number of unique incident numbers - my guess is something got duplicated.

race_by_year_unique <- tstops_demo %>%
  group_by(race_description, year) %>%
  mutate(race_ct = n()) %>%
  ungroup() %>%
  select(race_description, race_ct, year) %>%
  unique()

## Todo: Clean up x labels on race_by_year1 and have years increase by 1; remove x labels for second graph

race_by_year1 <- race_by_year_unique %>%
  ggplot(aes(x = year, y = race_ct ,fill = race_description)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(fill = "Race",
       title = "Number of stops by race per year",
       caption = "Data Publicly Available from Urbana Police Department") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  xlab("Year") +
  ylab("Number of Stops")
  
race_by_year2 <- race_by_year_unique %>%
  ggplot(aes(x = year, y = race_ct ,fill = race_description)) +
  geom_col() +
  labs(fill = "Race",
       title = "Number of stops by race per year",
       caption = "Data Publicly Available from Urbana Police Department") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  xlab("Year") +
  ylab("Number of Stops") +
  facet_grid(~race_description)

# Graph

race_by_year1 + race_by_year2
  

```

From the graphs above, you can see general trends in which traffic stops lowered by total volume around 2017, only to increase again in recent years.

## Disparity Ratio Calculations for 2019 and 2020

```{r disparity-ratios, echo=FALSE}
## First to include 2019 and 2020
disparity_ratios <- tstops_demo %>%
  filter(!race_description %in% c("AMERICAN INDIAN/ALASKAN", "UNKNOWN")) %>%
  group_by(year) %>%
  mutate(all = n()) %>%
  ungroup() %>%
  group_by(year, race_description) %>%
  mutate(race_ct = n(),
         race_percentage = 100 * race_ct / all,
         disparity_ratio = case_when(
           year >= 2018 & race_description == "ASIAN" ~ race_percentage / 8.37,
           year >= 2018 & race_description == "BLACK" ~ race_percentage / 22.26,
           year >= 2018 & race_description == "HISPANIC" ~ race_percentage / 4.84,
           year >= 2018 & race_description == "WHITE" ~ race_percentage / 62.23,
           year == 2017 & race_description == "ASIAN" ~ race_percentage / 9.07,
           year == 2017 & race_description == "BLACK" ~ race_percentage / 20.36,
           year == 2017 & race_description == "HISPANIC" ~ race_percentage / 4.4,
           year == 2017 & race_description == "WHITE" ~ race_percentage / 63.7,
           year == 2016 & race_description == "ASIAN" ~ race_percentage / 9.91,
           year == 2016 & race_description == "BLACK" ~ race_percentage / 18.56,
           year == 2016 & race_description == "HISPANIC" ~ race_percentage / 4.04,
           year == 2016 & race_description == "WHITE" ~ race_percentage / 65.54,
           year <= 2015 & race_description == "ASIAN" ~ race_percentage / 9.96,
           year <= 2015 & race_description == "BLACK" ~ race_percentage / 18.07,
           year <= 2015 & race_description == "HISPANIC" ~ race_percentage / 3.52,
           year <= 2015 & race_description == "WHITE" ~ race_percentage / 67.26)) %>%
  ungroup() %>%
  group_by(year, race_description, sex_description) %>%
  mutate(race_gender_ct = n(),
         race_gender_percentage = 100 * race_gender_ct / all,
         disparity_ratio_gender = case_when(
           year >= 2018 & race_description == "ASIAN" ~ race_gender_percentage / 8.37,
           year >= 2018 & race_description == "BLACK" ~ race_gender_percentage / 22.26,
           year >= 2018 & race_description == "HISPANIC" ~ race_gender_percentage / 4.84,
           year >= 2018 & race_description == "WHITE" ~ race_gender_percentage / 62.23,
           year == 2017 & race_description == "ASIAN" ~ race_gender_percentage / 9.07,
           year == 2017 & race_description == "BLACK" ~ race_gender_percentage / 20.36,
           year == 2017 & race_description == "HISPANIC" ~ race_gender_percentage / 4.4,
           year == 2017 & race_description == "WHITE" ~ race_gender_percentage / 63.7,
           year == 2016 & race_description == "ASIAN" ~ race_gender_percentage / 9.91,
           year == 2016 & race_description == "BLACK" ~ race_gender_percentage / 18.56,
           year == 2016 & race_description == "HISPANIC" ~ race_gender_percentage / 4.04,
           year == 2016 & race_description == "WHITE" ~ race_gender_percentage / 65.54,
           year <= 2015 & race_description == "ASIAN" ~ race_gender_percentage / 9.96,
           year <= 2015 & race_description == "BLACK" ~ race_gender_percentage / 18.07,
           year <= 2015 & race_description == "HISPANIC" ~ race_gender_percentage / 3.52,
           year <= 2015 & race_description == "WHITE" ~ race_gender_percentage / 67.26)) %>%
  ungroup() %>%
  select(year, race_description, disparity_ratio, disparity_ratio_gender, sex_description, race_percentage) %>%
  unique()

# Graph disparity ratios
disparity_ratios %>%
  ggplot(aes(year, disparity_ratio, color = race_description)) +
  geom_line() +
  scale_x_continuous(breaks = c(2012, 2013, 2014, 2015, 2016,2017, 2018, 2019, 2020)) +
  scale_y_continuous(breaks = seq(0, 2.5, by = 0.5)) +
  theme_minimal()

# Graph disparity ratios by gender
disparity_ratios %>%
  ggplot(aes(year, disparity_ratio_gender, color = sex_description)) +
  geom_line() +
  scale_x_continuous(breaks = c(2012, 2013, 2014, 2015, 2016,2017, 2018, 2019, 2020)) +
  scale_y_continuous(breaks = seq(0, 2.5, by = 0.5)) +
  theme_minimal() +
  facet_grid(~race_description)

## We'd need to either 1. Account for the different frequencies in male vs females being stopped, or 2. Find out the average # males and females stopped in Urbana to use as a "checkpoint" or baseline.

```



```{r tidymodels, echo=FALSE}
# Use tidymodels to split data into testing and training sets
tstops_demo_split <- initial_split(tstops_demo)

tstops_training <- tstops_demo_split %>%
  training()

tstops_testing <- tstops_demo_split %>%
  testing()


```


## Questions for Melissa
1. My numbers are slightly off, what could be the case? The biggest disparity is 2018, everything else is 1 or 2 stops off

2. Inconsistencies in # drivers from 2017 and 2018 report
