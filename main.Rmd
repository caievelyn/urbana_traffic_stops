---
title: "Urbana Traffic Stops"
author: "Evelyn Cai"
date: "6/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries
library(tidyverse)
library(janitor)
library(skimr)
library(lubridate)
library(tidymodels)
library(readxl)

# Read in data
df <- read_csv("urbana_traffic_stops.csv") %>%
  clean_names() %>%
  mutate(date_of_contact = mdy(date_of_contact))

# Additional ages
ages <- read_xlsx("Additional IDOT info.xlsx") %>%
  clean_names() %>%
  rename("incident_number" = "incident") %>%
  select(incident_number, age_at_contact) %>%
  unique()

# Join for ages
tstopoffenses <- left_join(df, ages, by = "incident_number") %>%
  rename("age_at_contact" = "age_at_contact.y") %>%
  select(-age_at_contact.x) %>%
  unique()
```

## Exploratory Data Analysis

```{r explore, eval=FALSE}
skim(tstopoffenses)
```

After runnning skim(), I wanted to explore why some values were missing. Some were obvious: `drug_amount_found_canine_search` was probably NA if a canine search was not involved. Others seem to be less logically missing, such as `motivation_for_stop_desc`, which has a lower complete rate compared to other variables. After exploring the data, I noticed that motivations were generally not reported before 4/30/2015.

```{r missing, eval=FALSE, include=FALSE}
# Filter for rows missing motivations and arrange by decreasing date; the largest date value is 4/30/2015. Note before we call the unique() function that there are 14,657 observations.
tstopoffenses %>%
  filter(is.na(motivation_for_stop_desc)) %>%
  select(date_of_contact) %>%
  unique() %>%
  arrange(desc(date_of_contact))

# Double check by approaching the problem in reverse: filter only for dates before 4/30/2015 (again, there are 14,657 observations). When filtering for those that have a motivation, there are only 11 - mostly traffic issues, one is community caretaking.
tstopoffenses %>% 
  filter(date_of_contact < "2015-04-30") %>%
  select(motivation_for_stop_desc) %>%
  filter(!is.na(motivation_for_stop_desc))
```

To work with the total number of traffic stops, rather than traffic stop offenses, we have to do some reshaping of the data.

```{r reshaping, echo=FALSE}

tstops <- tstopoffenses %>%
  group_by(incident_number) %>%
  # Create new variables that collapse multiple offenses into one column
  mutate(crime_descs  = paste(crime_description, collapse =", "),
         crime_codes = paste(crime_code, collapse = ", "),
         crime_status_descs = paste(crime_status_description, collapse = ", "),
         crime_categories = paste(crime_category, collapse = ", "),
         crime_category_descs = paste(crime_category_description, collapse = ", "),
         # Create new variable to count the number of offenses
         number_of_crimes = length(crime_codes)) %>%
  # Deselect duplicate columns
  select(-crime_code, -crime_description, -crime_status_description, -crime_category, -crime_category_description) %>%
  # Filter for unique incidents
  unique() %>%
  ungroup()

skim(tstops)
  
```

Upon fiddling with the data more, here's what I hope to put together by the end of the project:
* An imputed data set that accounts for missing values of key variables, specifically `age_at_contact`
* Interaction plots and parallel slopes models
* Regressions using `tidymodels` for training and testing sets, as well as which variables are the most useful
* Easily digestible plots that show:
    + Likelihood of being stopped (baseline) compared to likelihood of being stopped if you are a minority, a woman, other interesting subgroup comparisons
    + Outcome likelihoods after being stopped compared to a baseline (either group average or being white/male)
    + Impact of location and time of day on the stop
    
## Initial Analysis

```{r cleaning, echo=FALSE}

# It seems like in 2018 "Caucasian" turned into "White" and "African American" to "Black". 

tstops_demo <- tstops %>%
  # Select only for useful demographic and logistical information
  select(date_of_contact, time_of_contact, incident_number,
        motivation_for_stop_desc, race_description, sex_description,
        age_at_contact, residency_code, reason_for_stop,
        type_of_violation, vehicle_year, crime_descs,
        crime_status_descs) %>%
  # Extract year and month from date
  mutate(year = year(date_of_contact),
         month = month(date_of_contact),
         # Change "Caucasian" to "White" and factorize race
         race_description = as.factor(case_when(
           race_description == "CAUCASIAN" ~ "WHITE",
           race_description == "AFRICAN AMERICAN" ~ "BLACK",
           TRUE ~ race_description)))


# Use tidymodels to split data into testing and training sets
tstops_demo_split <- initial_split(tstops_demo)

tstops_training <- tstops_demo_split %>%
  training()

tstops_testing <- tstops_demo_split %>%
  testing()

tstops_training %>%
  group_by(race_description, year) %>%
  mutate(race_ct = n()) %>%
  ungroup() %>%
  select(race_description, race_ct, year) %>%
  unique() %>%
  ggplot(aes(x = year, y = race_ct)) +
  geom_line(aes(color = race_description))
  

```




